name: Release Version Test

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Enter the version for this release'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: 'main' # Ensures the main branch is checked out
          token: ${{ secrets.PAT_GITHUB }}

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org/'

      - name: Debug - Check packages/tools after checkout
        run: |
          echo "=== After checkout ==="
          echo "Current branch:"
          git branch -a
          echo "Current commit:"
          git log -1 --oneline
          echo "Remote origin URL:"
          git remote -v
          echo "Files in packages/tools:"
          ls -la packages/tools/ 2>&1 || echo "Directory does not exist"
          echo "Git status of packages/tools:"
          git status packages/tools/ 2>&1 || echo "No status"

      - name: Reset local changes
        run: |
          git fetch origin main
          git reset --hard origin/main
          git clean -fdx

      - name: Debug - Check packages/tools after reset
        run: |
          echo "=== After git reset --hard ==="
          echo "Current commit:"
          git log -1 --oneline
          echo "Files in packages/tools:"
          ls -la packages/tools/ 2>&1 || echo "Directory does not exist"
          echo "Git status of packages/tools:"
          git status packages/tools/ 2>&1 || echo "No status"
          echo "What git thinks should be in packages/tools:"
          git ls-tree -r HEAD --name-only | grep "^packages/tools/" | head -20 || echo "No files found"

      - name: Configure git user
        run: |
          git config user.name "Dariel Noel"
          git config user.email "darielnoel@gmail.com"

      - name: Install dependencies (with detailed logging)
        run: |
          echo "=== Before npm install ==="
          echo "Files in packages/tools:"
          ls -la packages/tools/ 2>&1 | head -20 || echo "Directory does not exist"
          echo "=== Running npm install with verbose logging ==="
          npm ci
          echo "=== npm install completed ==="
          echo "=== Checking for any postinstall scripts that ran ==="
          grep -i "postinstall\|prepare\|preinstall" npm-install.log | tail -20 || echo "No postinstall scripts found in log"

      - name: Debug - Check packages/tools after npm install
        run: |
          echo "=== After npm install ==="
          echo "Files in packages/tools:"
          ls -la packages/tools/ 2>&1 || echo "Directory does not exist"
          echo "Git status of packages/tools:"
          git status packages/tools/ 2>&1 || echo "No status"
          echo "=== Checking if packages/tools is tracked by git ==="
          git ls-files packages/tools/ | head -10 || echo "No tracked files found"
          echo "=== Checking git diff for packages/tools ==="
          git diff packages/tools/ | head -50 || echo "No diff found"

      - name: Build production version
        run: npm run build

      - name: Debug - Check packages/tools after build
        run: |
          echo "=== After build ==="
          echo "Files in packages/tools:"
          ls -la packages/tools/ 2>&1 || echo "Directory does not exist"
          echo "Git status of packages/tools:"
          git status packages/tools/ 2>&1 || echo "No status"

      - name: Display changes
        run: |
          echo "Showing status..."
          git status
          echo "Showing diff..."
          git diff

      - name: Update package.json version and create Git tag
        run: npm version ${{ github.event.inputs.version }}
